name: Auto Download YouTube Live M3U8

on:
  schedule:
    - cron: "0 */5 * * *"
  workflow_dispatch:

jobs:
  generate-m3u8:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Deno (JavaScript runtime for yt-dlp)
        run: |
          curl -fsSL https://deno.land/x/install/install.sh | sh
          echo "${HOME}/.deno/bin" >> $GITHUB_PATH

      - name: Verify Deno installation
        run: |
          echo "Deno path: $(which deno || echo 'not in PATH yet')"
          echo "Trying direct path: ${HOME}/.deno/bin/deno --version"
          ${HOME}/.deno/bin/deno --version

      - name: Install yt-dlp
        run: |
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp \
            -o /usr/local/bin/yt-dlp
          chmod a+rx /usr/local/bin/yt-dlp
          yt-dlp --version

      - name: Prepare cookies
        run: echo "${{ secrets.YOUTUBE_COOKIES }}" > ytb_cookie.txt

      - name: Create m3u8 directory
        run: mkdir -p m3u8

      - name: Generate m3u8 for each channel
        shell: bash
        env:
          DENO_BIN: ${{ runner.home }}/.deno/bin/deno
        run: |
          # ç¡®ä¿ Deno åœ¨ PATH ä¸­
          export PATH="${HOME}/.deno/bin:$PATH"
          
          # éªŒè¯ Deno å¯ç”¨
          echo "Deno version: $(deno --version)"
          echo "yt-dlp version: $(yt-dlp --version)"
          
          # èŽ·å–è„šæœ¬æ‰€åœ¨ç›®å½•ï¼ˆyamlåŒè·¯å¾„ï¼‰
          SCRIPT_DIR="${{ github.workspace }}"
          cd "$SCRIPT_DIR"
          
          echo "=== å¼€å§‹å¤„ç† channels.txt ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          if [ ! -f "channels.txt" ]; then
            echo "âŒ ERROR: channels.txt not found!"
            ls -la
            exit 1
          fi
          
          echo "channels.txt å†…å®¹:"
          cat channels.txt
          echo "==============================="
          
          # è®¡æ•°å™¨
          success_count=0
          fail_count=0
          
          # è¯»å– channels.txtï¼Œå¤„ç†æ¯ä¸ªé¢‘é“
          while IFS='|' read -r name url || [ -n "$name" ]; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$name" || "$name" =~ ^[[:space:]]*# ]] && continue
            
            # åŽ»é™¤å‰åŽç©ºæ ¼
            name=$(echo "$name" | xargs)
            url=$(echo "$url" | xargs)
            
            [[ -z "$url" ]] && continue
            
            echo "========================================="
            echo "ðŸ“º Processing: $name"
            echo "ðŸ”— URL: $url"
            
            # å°è¯•èŽ·å–ç›´æ’­æµåœ°å€ï¼Œå¤±è´¥ä¸é€€å‡º
            # æ˜¾å¼æŒ‡å®š Deno è·¯å¾„è§£å†³ JavaScript challenge
            addr=$(timeout 60 yt-dlp -g --cookies ytb_cookie.txt --js-runtimes deno "$url" 2>&1)
            exit_code=$?
            
            if [ $exit_code -ne 0 ]; then
              echo "âš ï¸  FAILED: $name (exit code: $exit_code)"
              echo "# ç›´æ’­æš‚æ—¶ä¸å¯ç”¨ - $(date '+%Y-%m-%d %H:%M:%S')" > "m3u8/${name}.m3u8"
              ((fail_count++))
              continue
            fi
            
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸèŽ·å–åˆ°åœ°å€
            if [[ "$addr" =~ ^https?:// ]]; then
              printf "#EXTM3U\n#EXT-X-VERSION:3\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=5400000\n%s\n" \
                "$addr" > "m3u8/${name}.m3u8"
              echo "âœ…  SUCCESS: $name"
              ((success_count++))
            else
              echo "âš ï¸  FAILED: $name - è¿”å›žæ— æ•ˆåœ°å€"
              echo "# ç›´æ’­æš‚æ—¶ä¸å¯ç”¨ - $(date '+%Y-%m-%d %H:%M:%S')" > "m3u8/${name}.m3u8"
              ((fail_count++))
            fi
            
          done < channels.txt
          
          echo "==============================="
          echo "=== å¤„ç†å®Œæˆ ==="
          echo "âœ… æˆåŠŸ: $success_count"
          echo "âš ï¸  å¤±è´¥: $fail_count"
          echo "ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la m3u8/

      - name: Remove cookie file
        run: rm -f ytb_cookie.txt || true

      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-live-m3u8
          path: m3u8/

      - name: Push to dedicated branch
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -B ytblive
          git add m3u8
          git commit -m "Update youtube live m3u8: $(date '+%Y-%m-%d %H:%M:%S')" || exit 0
          git push -f "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" ytblive
